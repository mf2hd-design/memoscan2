<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MemoScan â€“ Final Prototype (WebSocket)</title>
    <!-- We need to include the Socket.IO client library -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #007acc; --border-color: #ddd; --bg-light: #f7f7f7;
            --text-dark: #333; --text-light: #666; --error-color: #d9534f;
            --confidence-1: #d9534f; --confidence-2: #f0ad4e; --confidence-3: #5bc0de;
            --confidence-4: #5cb85c; --confidence-5: #0275d8;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-light); margin: 0; padding: 2rem; color: var(--text-dark); }
        h1, h2 { color: var(--primary-color); }
        #container { max-width: 900px; margin: 0 auto; }
        #form-section { background: #fff; padding: 1.5rem 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.08); margin-bottom: 2rem; }
        input[type=text] { width: calc(100% - 120px); padding: .75rem; border: 1px solid var(--border-color); border-radius: 6px; margin-right: 1rem; font-size: 1rem; }
        button { padding: .75rem 1.25rem; background: var(--primary-color); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 1rem; transition: background .2s; }
        button:hover { background: #005fa3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status-container { margin-top: 1.5rem; background: #fafafa; border-radius: 6px; padding: 0.5rem 1rem; color: var(--text-light); font-style: italic; max-height: 200px; overflow-y: auto; }
        #results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .result-block { background: #fff; border-left: 5px solid; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,.05); opacity: 0; transform: translateY(20px); animation: fadeIn .5s forwards; }
        .result-block.error { border-left-color: var(--error-color); }
        .result-block h3 { margin: 0 0 0.5rem; }
        .result-block p { margin: 0.25rem 0; font-size: 0.95rem; }
        .evidence { font-style: italic; color: var(--text-light); border-left: 3px solid #eee; padding-left: 1rem; margin-top: 0.75rem; }
        .confidence-bar { width: 100px; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .confidence-fill { height: 100%; width: 0%; background: var(--primary-color); transition: width .5s; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="container">
        <h1>ðŸ§  MemoScan</h1>
        <h2>Phase 1: Final Prototype</h2>
        <div id="form-section">
            <p>Enter a brand website URL to begin the memorability analysis:</p>
            <input id="url" type="text" placeholder="https://www.saffron-consultants.com">
            <button id="scan-button">Analyze Brand</button>
            <div id="status-container"></div>
        </div>
        <div id="results-grid"></div>
    </div>

<script>
    // --- THIS SCRIPT IS COMPLETELY NEW ---
    const urlInput = document.getElementById("url");
    const scanButton = document.getElementById("scan-button");
    const resultsGrid = document.getElementById("results-grid");
    const statusContainer = document.getElementById("status-container");
    
    // Connect to the WebSocket server
    const socket = io();

    socket.on('connect', () => {
        console.log('Connected to WebSocket server!');
        statusContainer.innerHTML = `<div>Ready.</div>`;
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from WebSocket server.');
        statusContainer.innerHTML += `<div style="color: red;"><strong>Connection Lost.</strong> Please refresh the page.</div>`;
    });

    scanButton.addEventListener("click", () => {
        const url = urlInput.value.trim();
        if (!url) {
            alert("Please enter a URL.");
            return;
        }
        
        scanButton.disabled = true;
        scanButton.textContent = "Analyzing...";
        resultsGrid.innerHTML = "";
        statusContainer.innerHTML = ""; // Clear status container
        
        // Instead of fetching a URL, we 'emit' an event to the server.
        socket.emit('start_scan', { url: url });
    });

    // This is our listener for all messages from the server.
    socket.on('scan_update', (msg) => {
        // The server wraps our original data in a 'data' key.
        const line = msg.data.trim();

        if (line.startsWith("[STATUS]")) {
            const statusMsg = line.replace("[STATUS]", "").trim();
            statusContainer.innerHTML += `<div>${statusMsg}</div>`;
            statusContainer.scrollTop = statusContainer.scrollHeight;
        } else if (line.startsWith("[ERROR]")) {
            const errorMsg = line.replace("[ERROR]", "").trim();
            resultsGrid.innerHTML += `<div class="result-block error">${errorMsg}</div>`;
        } else if (line.startsWith("[COMPLETE]")) {
            statusContainer.innerHTML += `<div><strong>Analysis Complete.</strong></div>`;
            statusContainer.scrollTop = statusContainer.scrollHeight;
            scanButton.disabled = false;
            scanButton.textContent = "Analyze Brand";
        } else {
            try {
                // The JSON data comes through directly
                const data = JSON.parse(line);
                if (data.key && data.analysis) {
                    renderResultBlock(data.key, data.analysis);
                }
            } catch (e) {
                console.warn("Ignoring non-JSON message:", line, e);
            }
        }
    });

    function renderResultBlock(key, analysis) {
        const score = analysis.score || 0;
        const confidence = analysis.confidence || 1;
        const confidenceColor = getComputedStyle(document.documentElement).getPropertyValue(`--confidence-${confidence}`);

        const block = document.createElement("div");
        block.className = "result-block";
        block.style.borderLeftColor = confidenceColor;

        block.innerHTML = `
            <h3>${key} â€“ <span class="score">${score}/100</span></h3>
            <p>${analysis.justification || "No justification provided."}</p>
            <p class="evidence"><strong>Evidence:</strong> ${analysis.evidence || "None cited."}</p>
            <div>
                <p style="margin-bottom: 0;"><strong>Confidence:</strong> ${confidence}/5</p>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${confidence * 20}%; background-color: ${confidenceColor};"></div>
                </div>
            </div>
        `;
        resultsGrid.appendChild(block);
    }
</script>
</body>
</html>
