<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MemoScan Dashboard</title>
  <style>
    :root {
      --primary: #007acc; --bg: #f7f7f7; --text: #222; --muted:#666; --card:#fff;
      --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    }
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { background: #fff; border-bottom: 1px solid #eee; padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 1; }
    .brand { font-weight: 700; color: var(--primary); }
    .tabs { display: flex; gap: .5rem; margin-top: .75rem; }
    .tab { padding: .5rem .75rem; border-radius: 8px; cursor: pointer; color: var(--primary); border: 1px solid var(--primary); background: #fff; }
    .tab.active { background: var(--primary); color: #fff; }
    main { max-width: 1100px; margin: 1rem auto; padding: 0 1rem 2rem; }
    .panel { background: var(--card); border: 1px solid #eee; border-radius: 12px; padding: 1rem; margin: 1rem 0; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1rem; }
    .kpi { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: .75rem 1rem; }
    .kpi h4 { margin: 0 0 .25rem; font-size: .9rem; color: var(--muted); font-weight: 500; }
    .kpi .v { font-size: 1.6rem; font-weight: 700; color: var(--primary); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: .5rem .5rem; border-bottom: 1px solid #eee; font-size: .9rem; }
    th { color: var(--muted); font-weight: 600; }
    .muted { color: var(--muted); }
    .pill { display: inline-block; padding: .15rem .5rem; border-radius: 999px; font-size: .75rem; border: 1px solid #ddd; }
    .pill.ok { color: var(--ok); border-color: var(--ok); }
    .pill.warn { color: var(--warn); border-color: var(--warn); }
    .pill.err { color: var(--err); border-color: var(--err); }
    .controls { display: flex; gap: .5rem; align-items: center; }
    select { padding: .4rem .5rem; border-radius: 8px; border: 1px solid #ddd; background: #fff; }
    @media (max-width: 640px) { .tabs { flex-wrap: wrap; } }
  </style>
</head>
<body>
  <header>
    <div class="brand">MemoScan Dashboard</div>
    <div class="tabs">
      <div class="tab active" data-view="metrics">Metrics</div>
      <div class="tab" data-view="costs">Costs</div>
      <div class="tab" data-view="feedback">Feedback</div>
      <div class="tab" data-view="disc-feedback">Discovery Feedback</div>
      <div class="tab" data-view="improvements">Improvements</div>
      <div class="tab" data-view="errors">Errors</div>
    </div>
  </header>
  <main>
    <div class="controls panel">
      <label for="hours" class="muted">Time window:</label>
      <select id="hours">
        <option value="6">Last 6h</option>
        <option value="24" selected>Last 24h</option>
        <option value="72">Last 72h</option>
        <option value="168">Last 7d</option>
      </select>
      <span id="status" class="muted"></span>
    </div>

    <section id="view-metrics">
      <div class="row">
        <div class="kpi"><h4>Total scans</h4><div class="v" id="kpi-total">—</div></div>
        <div class="kpi"><h4>Completed</h4><div class="v" id="kpi-completed">—</div></div>
        <div class="kpi"><h4>Failed</h4><div class="v" id="kpi-failed">—</div></div>
        <div class="kpi"><h4>Cancelled</h4><div class="v" id="kpi-cancelled">—</div></div>
        <div class="kpi"><h4>Completion rate</h4><div class="v" id="kpi-rate">—</div></div>
        <div class="kpi"><h4>Avg duration (s)</h4><div class="v" id="kpi-avg">—</div></div>
      </div>
      <div class="row">
        <div class="kpi"><h4>Diagnosis scans (24h)</h4><div class="v" id="kpi-diag">—</div></div>
        <div class="kpi"><h4>Discovery scans (24h)</h4><div class="v" id="kpi-disc">—</div></div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">Recent scans</h3>
        <table id="metrics-table"><thead><tr><th>Start (CEST)</th><th>URL</th><th>Mode</th><th>Status</th><th>Duration</th><th>Summary</th><th>Details</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">Models (last window)</h3>
        <table id="models-table"><thead><tr><th>Category</th><th>Key</th><th>Count</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-costs" style="display:none;">
      <div class="row">
        <div class="kpi"><h4>Total cost</h4><div class="v" id="cost-total">—</div></div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">By API</h3>
        <table id="costs-table"><thead><tr><th>API</th><th>Cost</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">High-cost calls</h3>
        <table id="highcost-table"><thead><tr><th>When</th><th>API</th><th>Cost</th><th class="muted">Details</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-feedback" style="display:none;">
      <div class="panel">
        <h3 style="margin-top:0">Summary</h3>
        <div class="row">
          <div class="kpi"><h4>Total feedback</h4><div class="v" id="fb-total">—</div></div>
        </div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">By key</h3>
        <table id="fb-bykey"><thead><tr><th>Key</th><th>Count</th><th>Avg score diff</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">Systematic issues</h3>
        <table id="fb-issues"><thead><tr><th>Issue</th><th>Count</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-disc-feedback" style="display:none;">
      <div class="panel">
        <h3 style="margin-top:0">Discovery Feedback Summary</h3>
        <div class="row">
          <div class="kpi"><h4>Total</h4><div class="v" id="dfb-total">—</div></div>
          <div class="kpi"><h4>Helpful rate</h4><div class="v" id="dfb-helpful-rate">—</div></div>
        </div>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">By key</h3>
        <table id="dfb-bykey"><thead><tr><th>Key</th><th>Count</th><th>Helpful rate</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">By category</h3>
        <table id="dfb-bycat"><thead><tr><th>Category</th><th>Count</th></tr></thead><tbody></tbody></table>
      </div>
      <div class="panel">
        <h3 style="margin-top:0">Recent (last 50)</h3>
        <table id="dfb-recent"><thead><tr><th>Time</th><th>Scan</th><th>Key</th><th>Helpful</th><th>Category</th><th>Comment</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-improvements" style="display:none;">
      <div class="panel">
        <h3 style="margin-top:0">Prompt improvement suggestions</h3>
        <table id="imp-table"><thead><tr><th>Area</th><th>Recommendation</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="view-errors" style="display:none;">
      <div class="panel">
        <h3 style="margin-top:0">Recent errors</h3>
        <table id="err-table"><thead><tr><th>Time</th><th>Source</th><th>Scan ID</th><th>Key</th><th>Message</th></tr></thead><tbody></tbody></table>
      </div>
    </section>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const views = {
      metrics: $('#view-metrics'),
      costs: $('#view-costs'),
      feedback: $('#view-feedback'),
      improvements: $('#view-improvements')
    };
    $$('.tab').forEach(t => t.addEventListener('click', () => {
      $$('.tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const v = t.getAttribute('data-view');
      Object.entries(views).forEach(([k, el]) => el.style.display = (k === v) ? 'block' : 'none');
      refresh();
    }));

    $('#hours').addEventListener('change', refresh);

    async function api(path) {
      const hours = $('#hours').value;
      const url = `${path}?hours=${encodeURIComponent(hours)}&_=${Date.now()}`; // bust caches
      $('#status').textContent = 'Loading…';
      const res = await fetch(url);
      const data = await res.json();
      $('#status').textContent = '';
      return data;
    }

    function fmt(n) {
      if (n == null) return '—';
      if (typeof n === 'number') return Number.isInteger(n) ? n.toString() : n.toFixed(2);
      return String(n);
    }

    async function loadMetrics() {
      const m = await api('/dashboard/api/metrics');
      $('#kpi-total').textContent = fmt(m.total_scans);
      $('#kpi-completed').textContent = fmt(m.completed);
      $('#kpi-failed').textContent = fmt(m.failed);
      $('#kpi-cancelled').textContent = fmt(m.cancelled);
      $('#kpi-rate').textContent = m.completion_rate != null ? (m.completion_rate * 100).toFixed(0) + '%' : '—';
      $('#kpi-avg').textContent = m.avg_duration != null ? Math.round(m.avg_duration) : '—';
      // Recent scans
      const scans = await api('/dashboard/api/scans');
      const tbody = $('#metrics-table tbody');
      tbody.innerHTML = '';
      (scans.scans || []).slice(0, 50).forEach((rec, idx) => {
        const dt = rec.start_ts ? new Date(rec.start_ts * 1000) : null;
        const start = dt ? `${dt.toLocaleDateString('de-DE', { timeZone: 'Europe/Berlin' })} ${dt.toLocaleTimeString('de-DE', { timeZone: 'Europe/Berlin', hour12: false })} CEST` : '—';
        const dur = rec.duration_s != null ? `${rec.duration_s}s` : (rec.end_ts && rec.start_ts) ? `${Math.max(0, Math.round(rec.end_ts - rec.start_ts))}s` : '—';
        const sum = rec.summary ? `OK ${rec.summary.ok||0} • Fallback ${rec.summary.fallback||0} • Errors ${rec.summary.errors||0}` : '';
        const detailsId = `scan-details-${idx}`;
        const tr = document.createElement('tr');
        const urlCell = rec.url ? `<a href="${rec.url}" target="_blank" rel="noopener">${rec.url}</a>` : '—';
        tr.innerHTML = `<td>${start}</td><td class="muted" style="max-width:420px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${urlCell}</td><td>${rec.mode||'diagnosis'}</td><td>${rec.status}</td><td>${dur}</td><td>${sum}</td><td><button data-target="${detailsId}">Expand</button></td>`;
        tbody.appendChild(tr);
        // Expandable row
        const tr2 = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 7;
        td.style.display = 'none';
        td.id = detailsId;
        const elems = rec.elements || [];
        let inner = '<table style="width:100%"><thead><tr><th>Element</th><th>Status</th><th>Model</th><th>Tokens</th><th>Error</th></tr></thead><tbody>';
        elems.forEach(e => {
          inner += `<tr><td>${e.element||''}</td><td>${e.status||''}</td><td>${e.model_id||''}</td><td>${e.token_usage!=null? e.token_usage: ''}</td><td class="muted">${e.error||''}</td></tr>`;
        });
        inner += '</tbody></table>';
        td.innerHTML = inner;
        tr2.appendChild(td);
        tbody.appendChild(tr2);
        // Wire toggle
        tr.querySelector('button').addEventListener('click', () => {
          td.style.display = (td.style.display === 'none') ? '' : 'none';
        });
      });
    }

    async function loadCosts() {
      const c = await api('/dashboard/api/costs');
      $('#cost-total').textContent = c.total != null ? `$${c.total.toFixed(2)}` : '—';
      const tbody = $('#costs-table tbody');
      tbody.innerHTML = '';
      if (c.by_api) {
        Object.entries(c.by_api).forEach(([api, cost]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${api}</td><td>$${Number(cost).toFixed(2)}</td>`;
          tbody.appendChild(tr);
        });
      }
      const hi = $('#highcost-table tbody');
      hi.innerHTML = '';
      (c.high_cost_calls || []).forEach(entry => {
        const tr = document.createElement('tr');
        const dt = new Date(entry.timestamp*1000);
        const when = dt.toLocaleString('de-DE', { timeZone: 'Europe/Berlin', hour12: false });
        tr.innerHTML = `<td>${when}</td><td>${entry.api_type||'—'}</td><td>$${Number(entry.cost||0).toFixed(2)}</td><td class="muted">${entry.details?JSON.stringify(entry.details):'—'}</td>`;
        hi.appendChild(tr);
      });
    }

    async function loadFeedback() {
      const f = await api('/dashboard/api/feedback/analytics');
      $('#fb-total').textContent = fmt(f.total_feedback || (f.error ? 0 : '—'));
      const byKey = $('#fb-bykey tbody');
      byKey.innerHTML = '';
      if (f.by_key) {
        Object.entries(f.by_key).forEach(([k, v]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${k}</td><td>${fmt(v.count)}</td><td>${fmt(v.avg_score_diff)}</td>`;
          byKey.appendChild(tr);
        });
      }
      const issues = $('#fb-issues tbody');
      issues.innerHTML = '';
      if (f.systematic_issues) {
        Object.entries(f.systematic_issues).forEach(([k, v]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${k}</td><td>${fmt(v)}</td>`;
          issues.appendChild(tr);
        });
      }
    }

    async function loadImprovements() {
      const imp = await api('/dashboard/api/feedback/improvements');
      const tbody = $('#imp-table tbody');
      tbody.innerHTML = '';
      const items = Array.isArray(imp) ? imp : (imp.items || []);
      items.forEach(i => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i.area||'General'}</td><td>${i.recommendation||i.text||JSON.stringify(i)}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function refresh() {
      const active = document.querySelector('.tab.active').getAttribute('data-view');
      if (active === 'metrics') await loadMetrics();
      if (active === 'costs') await loadCosts();
      if (active === 'feedback') await loadFeedback();
      if (active === 'improvements') await loadImprovements();
      if (active === 'disc-feedback') await loadDiscoveryFeedback();
      if (active === 'errors') await loadErrors();
    }

    refresh();
    // Auto-refresh every 15 seconds
    setInterval(refresh, 15000);

    async function loadErrors() {
      const e = await api('/dashboard/api/errors');
      const tbody = $('#err-table tbody');
      tbody.innerHTML = '';
      (e.errors || []).forEach(row => {
        const tr = document.createElement('tr');
        const when = row.timestamp ? new Date(row.timestamp * 1000).toLocaleString('de-DE', { timeZone: 'Europe/Berlin', hour12: false }) : '—';
        tr.innerHTML = `<td>${when}</td><td>${row.source||'—'}</td><td>${row.scan_id||'—'}</td><td>${row.key_name||'—'}</td><td>${(row.message||'').toString().slice(0,200)}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadModels() {
      const adv = await api('/dashboard/api/metrics/advanced');
      // Mode breakdown
      const diag = adv.by_mode && adv.by_mode.diagnosis || 0;
      const disc = adv.by_mode && adv.by_mode.discovery && adv.by_mode.discovery.total_scans || 0;
      $('#kpi-diag').textContent = fmt(diag);
      $('#kpi-disc').textContent = fmt(disc);
      // Models table
      const tbody = $('#models-table tbody');
      tbody.innerHTML = '';
      const models = adv.models || {};
      Object.entries(models.discovery_analysis_success || {}).forEach(([model, count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>Discovery success</td><td>${model}</td><td>${fmt(count)}</td>`;
        tbody.appendChild(tr);
      });
      Object.entries(models.api_calls_by_type || {}).forEach(([api, count]) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>API calls</td><td>${api}</td><td>${fmt(count)}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Extend refresh to load model breakdown alongside metrics
    const _origLoadMetrics = loadMetrics;
    loadMetrics = async function() {
      await _origLoadMetrics();
      await loadModels();
    }

    async function loadDiscoveryFeedback() {
      const f = await api('/dashboard/api/discovery/feedback');
      $('#dfb-total').textContent = fmt(f.total);
      $('#dfb-helpful-rate').textContent = f.helpful_rate != null ? (f.helpful_rate * 100).toFixed(0) + '%' : '—';
      // by key
      const bk = $('#dfb-bykey tbody');
      bk.innerHTML = '';
      if (f.by_key) {
        Object.entries(f.by_key).forEach(([key, v]) => {
          const tr = document.createElement('tr');
          const rate = v.helpful_rate != null ? (v.helpful_rate * 100).toFixed(0) + '%' : '—';
          tr.innerHTML = `<td>${key}</td><td>${fmt(v.count)}</td><td>${rate}</td>`;
          bk.appendChild(tr);
        });
      }
      // by category
      const bc = $('#dfb-bycat tbody');
      bc.innerHTML = '';
      if (f.by_category) {
        Object.entries(f.by_category).forEach(([cat, c]) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${cat}</td><td>${fmt(c)}</td>`;
          bc.appendChild(tr);
        });
      }
      // recent
      const rc = $('#dfb-recent tbody');
      rc.innerHTML = '';
      (f.recent || []).forEach(r => {
        const tr = document.createElement('tr');
        const when = r.timestamp ? new Date(r.timestamp * 1000).toLocaleString('de-DE', { timeZone: 'Europe/Berlin', hour12: false }) : '—';
        tr.innerHTML = `<td>${when}</td><td>${r.scan_id||'—'}</td><td>${r.key_name||'—'}</td><td>${r.helpful? 'Yes':'No'}</td><td>${r.category||'—'}</td><td>${(r.comment||'')}</td>`;
        rc.appendChild(tr);
      });
    }
  </script>
</body>
</html>

