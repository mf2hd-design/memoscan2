services:
  # Backend API
  - type: web
    name: sbf-backend
    env: docker
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    plan: standard
    healthCheckPath: /health

    # Managed PostgreSQL for LangGraph checkpoints
    databases:
      - name: sbf-postgres
        plan: starter

    envVars:
      # API Keys (set as secrets in Render dashboard)
      - key: OPENAI_API_KEY
        sync: false
      - key: SCRAPFLY_KEY
        sync: false

      # Database (auto-injected by Render)
      - key: DATABASE_URL
        fromDatabase:
          name: sbf-postgres
          property: connectionString

      # App Configuration
      - key: ENVIRONMENT
        value: production
      - key: LOG_LEVEL
        value: INFO
      - key: DEBUG
        value: "false"

      # Rate Limiting
      - key: RATE_LIMIT_PER_HOUR
        value: "3"

      # Cache
      - key: CACHE_TTL_HOURS
        value: "24"
      - key: CACHE_DIR
        value: /tmp/sbf_cache

      # GPT-5.1 Config
      - key: GPT5_MODEL
        value: gpt-5.1-2025-11-13
      - key: GPT5_TIMEOUT
        value: "180"
      - key: CIRCUIT_BREAKER_THRESHOLD
        value: "3"
      - key: CIRCUIT_BREAKER_COOLDOWN
        value: "600"

      # Scrapfly Config
      - key: SCRAPFLY_ASP
        value: "true"
      - key: SCRAPFLY_RENDER_JS
        value: "true"
      - key: SCRAPFLY_TIMEOUT
        value: "30000"

      # ChromaDB (in-memory)
      - key: CHROMA_PERSIST
        value: "false"

      # Processing Limits
      - key: MAX_CONCURRENT_SCRAPES
        value: "10"
      - key: MAX_PDF_SIZE_MB
        value: "10"
      - key: MAX_CONTEXT_TOKENS
        value: "50000"

      # Timeouts
      - key: WORKFLOW_TIMEOUT
        value: "900"
      - key: SCRAPE_TIMEOUT
        value: "45"

  # Frontend (Next.js)
  - type: web
    name: sbf-frontend
    env: node
    buildCommand: cd frontend && npm install && npm run build
    startCommand: cd frontend && npm start
    plan: starter

    envVars:
      - key: NEXT_PUBLIC_API_URL
        fromService:
          type: web
          name: sbf-backend
          envVarKey: RENDER_EXTERNAL_URL
      - key: NODE_ENV
        value: production
